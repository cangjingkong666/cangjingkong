<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络测试工具集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; }
        .test-item { margin-bottom: 1rem; padding: 0.8rem; border-radius: 0.5rem; background-color: #f8fafc; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .loading { animation: spin 1.5s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 md:p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-5">
        <!-- 导航栏 -->
        <nav class="mb-8 flex flex-wrap gap-3">
            <button onclick="switchPage('page1')" class="nav-btn bg-blue-500 text-white py-2 px-4 rounded transition">页面1：DNS连通性测试</button>
            <button onclick="switchPage('page2')" class="nav-btn bg-gray-200 text-gray-700 py-2 px-4 rounded transition">页面2：网址延迟测试</button>
            <button onclick="switchPage('page3')" class="nav-btn bg-gray-200 text-gray-700 py-2 px-4 rounded transition">页面3：IP信息查询</button>
        </nav>

        <!-- 页面1：DNS测试（纯前端模拟，无API） -->
        <div id="page1" class="page active">
            <h2 class="text-xl font-bold text-blue-600 mb-4">DNS服务器连通性测试</h2>
            <p class="text-gray-600 mb-4">通过访问DNS服务器关联域名，模拟连通性检测</p>
            <button onclick="testAllDNS()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-6 transition">开始DNS测试</button>
            <div id="dnsTestResult" class="space-y-3"></div>
        </div>

        <!-- 页面2：网址延迟测试（纯前端计时，无依赖） -->
        <div id="page2" class="page">
            <h2 class="text-xl font-bold text-blue-600 mb-4">常用网址延迟测试</h2>
            <p class="text-gray-600 mb-4">通过资源加载计时，精准显示延迟（无第三方依赖）</p>
            <button onclick="testAllUrls()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-4 transition">测试默认网址</button>
            <div class="flex flex-wrap gap-2 mb-6">
                <input type="text" id="customUrl" placeholder="输入网址（如https://www.baidu.com）" class="flex-1 min-w-[200px] p-2 border rounded" value="https://www.baidu.com">
                <button onclick="testCustomUrl()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded transition">测试自定义网址</button>
            </div>
            <div id="urlTestResult" class="space-y-3"></div>
        </div>

        <!-- 页面3：IP信息查询（纯前端接口，无验证） -->
        <div id="page3" class="page">
            <h2 class="text-xl font-bold text-blue-600 mb-4">IP基础信息查询</h2>
            <p class="text-gray-600 mb-4">使用纯前端公开接口，无拦截无验证</p>
            <button onclick="testIPInfo()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-6 transition">开始查询IP</button>
            <div id="ipInfoResult" class="bg-gray-50 p-4 rounded min-h-[150px] whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        // 页面切换逻辑（兼容所有浏览器）
        function switchPage(pageId) {
            const targetBtn = event.target;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(pageId).classList.add('active');
            targetBtn.classList.add('bg-blue-500', 'text-white');
            targetBtn.classList.remove('bg-gray-200', 'text-gray-700');
        }

        // -------------------------- 页面1：DNS测试（纯前端模拟，解决无法使用） --------------------------
        // 关联DNS服务器与对应测试域名（确保可访问）
        const dnsServerMap = [
            { name: "国内-114 DNS", ip: "114.114.114.114", testDomain: "https://www.114dns.com" },
            { name: "国内-阿里DNS", ip: "223.5.5.5", testDomain: "https://www.aliyun.com" },
            { name: "国内-腾讯DNS", ip: "119.29.29.29", testDomain: "https://www.qq.com" },
            { name: "国内-华为DNS", ip: "124.160.88.160", testDomain: "https://www.huawei.com" },
            { name: "国外-Cloudflare DNS", ip: "1.1.1.1", testDomain: "https://www.cloudflare.com" }
        ];

        // 单个DNS测试（通过访问关联域名模拟连通性）
        async function testSingleDNS(serverItem) {
            return new Promise((resolve) => {
                const start = performance.now();
                const timeoutId = setTimeout(() => {
                    resolve({
                        server: serverItem,
                        status: "error",
                        delay: "5000.00",
                        reason: "5秒超时，DNS可能不可用"
                    });
                }, 5000);

                // 访问DNS关联域名，模拟连通性
                const img = new Image();
                img.src = `${serverItem.testDomain}/favicon.ico?t=${Date.now()}`;
                img.onload = () => {
                    clearTimeout(timeoutId);
                    const delay = (performance.now() - start).toFixed(2);
                    resolve({
                        server: serverItem,
                        status: "success",
                        delay,
                        info: "关联域名访问成功，DNS连通"
                    });
                };
                img.onerror = () => {
                    clearTimeout(timeoutId);
                    const delay = (performance.now() - start).toFixed(2);
                    resolve({
                        server: serverItem,
                        status: "error",
                        delay,
                        reason: "关联域名访问失败，DNS可能不可用"
                    });
                };
            });
        }

        // 批量测试所有DNS
        async function testAllDNS() {
            const resultEl = document.getElementById('dnsTestResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在测试5个DNS服务器，请稍候...';
            let html = '';

            const testResults = await Promise.all(dnsServerMap.map(item => testSingleDNS(item)));
            testResults.forEach(res => {
                html += res.status === "success"
                    ? `<div class="test-item success">
                        <strong>${res.server.name}</strong>（IP：${res.server.ip}）<br>
                        状态：连通 | 延迟：${res.delay}ms | 信息：${res.info}
                    </div>`
                    : `<div class="test-item error">
                        <strong>${res.server.name}</strong>（IP：${res.server.ip}）<br>
                        状态：不通 | 耗时：${res.delay}ms | 原因：${res.reason}
                    </div>`;
            });

            resultEl.innerHTML = html;
        }

        // -------------------------- 页面2：网址延迟测试（纯前端计时，解决不准确） --------------------------
        const commonUrls = [
            { name: "百度", url: "https://www.baidu.com" },
            { name: "淘宝", url: "https://www.taobao.com" },
            { name: "京东", url: "https://www.jd.com" },
            { name: "知乎", url: "https://www.zhihu.com" },
            { name: "微博", url: "https://weibo.com" }
        ];

        // 单个网址延迟测试（纯前端资源加载计时）
        async function testSingleUrl(urlItem) {
            return new Promise((resolve) => {
                const start = performance.now();
                const timeoutId = setTimeout(() => {
                    resolve({
                        item: urlItem,
                        status: "error",
                        delay: "6000.00",
                        reason: "6秒超时，网址可能无法访问"
                    });
                }, 6000);

                // 加载小体积资源（favicon）计时，避免大资源影响延迟
                fetch(`${urlItem.url}/favicon.ico?t=${Date.now()}`, {
                    method: "GET",
                    cache: "no-store", // 禁用缓存，确保每次全新请求
                    mode: "no-cors" // 兼容跨域，避免拦截
                })
                .then(() => {
                    clearTimeout(timeoutId);
                    const delay = (performance.now() - start).toFixed(2);
                    resolve({
                        item: urlItem,
                        status: "success",
                        delay,
                        info: "资源加载成功"
                    });
                })
                .catch(() => {
                    clearTimeout(timeoutId);
                    const delay = (performance.now() - start).toFixed(2);
                    resolve({
                        item: urlItem,
                        status: "error",
                        delay,
                        reason: "资源加载失败，网址可能不可用"
                    });
                });
            });
        }

        // 批量测试默认网址
        async function testAllUrls() {
            const resultEl = document.getElementById('urlTestResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在测试5个常用网址，请稍候...';
            let html = '';

            const testResults = await Promise.all(commonUrls.map(item => testSingleUrl(item)));
            testResults.forEach(res => {
                html += res.status === "success"
                    ? `<div class="test-item success">
                        <strong>${res.item.name}</strong>（${res.item.url}）<br>
                        状态：可访问 | 延迟：${res.delay}ms | 信息：${res.info}
                    </div>`
                    : `<div class="test-item error">
                        <strong>${res.item.name}</strong>（${res.item.url}）<br>
                        状态：不可访问 | 耗时：${res.delay}ms | 原因：${res.reason}
                    </div>`;
            });

            resultEl.innerHTML = html;
        }

        // 测试自定义网址
        async function testCustomUrl() {
            const inputUrl = document.getElementById('customUrl').value.trim();
            const resultEl = document.getElementById('urlTestResult');
            
            if (!inputUrl.startsWith('http')) {
                alert("请输入完整网址（需包含http://或https://）");
                return;
            }

            const urlItem = { name: "自定义网址", url: inputUrl };
            resultEl.innerHTML = `<span class="loading">●</span>正在测试：${inputUrl}`;
            
            const res = await testSingleUrl(urlItem);
            const customHtml = res.status === "success"
                ? `<div class="test-item success border-t-2 border-green-500 pt-3 mt-3">
                    <strong>${res.item.name}</strong>（${res.item.url}）<br>
                    状态：可访问 | 延迟：${res.delay}ms | 信息：${res.info}
                </div>`
                : `<div class="test-item error border-t-2 border-red-500 pt-3 mt-3">
                    <strong>${res.item.name}</strong>（${res.item.url}）<br>
                    状态：不可访问 | 耗时：${res.delay}ms | 原因：${res.reason}
                </div>`;

            resultEl.innerHTML = customHtml + resultEl.innerHTML.replace(`<span class="loading">●</span>正在测试：${inputUrl}`, '');
            document.getElementById('customUrl').value = '';
        }

        // -------------------------- 页面3：IP信息查询（纯前端接口，解决无法使用） --------------------------
        // 纯前端公开IP接口（无验证无拦截）
        const ipApiList = [
            "https://api.ipify.org?format=json", // 获取IP
            "https://ipapi.co/json/" // 获取IP+归属地
        ];

        async function testIPInfo() {
            const resultEl = document.getElementById('ipInfoResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在查询IP信息，请稍候...';
            
            try {
                // 1. 获取公网IP
                const ipRes = await fetch(ipApiList[0], { timeout: 5000 });
                const ipData = await ipRes.json();
                const publicIp = ipData.ip || '未知';

                // 2. 获取IP归属地
                const ipLocRes = await fetch(`${ipApiList[1]}${publicIp}`, { timeout: 5000 });
                const ipLocData = await ipLocRes.json();

                // 整理结果
                const result = `
当前IP信息查询结果：
1. 公网IP地址：${publicIp}
2. 归属地信息：
   - 国家：${ipLocData.country_name || '未知'}
   - 地区：${ipLocData.region || '未知'}
   - 城市：${ipLocData.city || '未知'}
3. 网络信息：
   - 运营商：${ipLocData.org || '未知'}
   - 时区：${ipLocData.timezone || '未知'}
   - 经纬度：${ipLocData.latitude || '未知'}, ${ipLocData.longitude || '未知'}
                `;
                resultEl.textContent = result;
            } catch (err) {
                resultEl.textContent = `查询成功（基础IP）：\n公网IP地址：${await getIpByFallback()}\n归属地查询失败，建议刷新页面重试`;
            }
        }

        // 备用IP获取（防止主接口失效）
        async function getIpByFallback() {
            try {
                const res = await fetch("https://icanhazip.com", { timeout: 3000 });
                return await res.text().then(ip => ip.trim());
            } catch {
                return "无法获取IP，请检查网络";
            }
        }
    </script>
</body>
</html>
