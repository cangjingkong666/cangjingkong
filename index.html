<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络测试工具集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; }
        .test-item { margin-bottom: 1rem; padding: 0.8rem; border-radius: 0.5rem; background-color: #f8fafc; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .loading { animation: spin 1.5s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 md:p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-5">
        <!-- 导航栏 -->
        <nav class="mb-8 flex flex-wrap gap-3">
            <button onclick="switchPage('page1')" class="nav-btn bg-blue-500 text-white py-2 px-4 rounded transition">页面1：DNS全面测试</button>
            <button onclick="switchPage('page2')" class="nav-btn bg-gray-200 text-gray-700 py-2 px-4 rounded transition">页面2：网址延迟测试</button>
            <button onclick="switchPage('page3')" class="nav-btn bg-gray-200 text-gray-700 py-2 px-4 rounded transition">页面3：IP与DNS归属地</button>
        </nav>

        <!-- 页面1：DNS测试（修复：国内DNS解析API，无跨域） -->
        <div id="page1" class="page active">
            <h2 class="text-xl font-bold text-blue-600 mb-4">DNS服务器连通性与延迟测试</h2>
            <p class="text-gray-600 mb-4">使用阿里DNS开放API，支持UDP协议测试，无跨域限制</p>
            <button onclick="testAllDNS()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-6 transition">开始全面DNS测试</button>
            <div id="dnsTestResult" class="space-y-3"></div>
        </div>

        <!-- 页面2：网址延迟测试（新增17个高频网址） -->
        <div id="page2" class="page">
            <h2 class="text-xl font-bold text-blue-600 mb-4">常用网址延迟测试</h2>
            <p class="text-gray-600 mb-4">覆盖国内10个/国外7个高频网址，通过图标加载计时</p>
            <button onclick="testAllUrls()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-4 transition">测试所有默认网址</button>
            
            <!-- 自定义网址输入 -->
            <div class="flex flex-wrap gap-2 mb-6">
                <input type="text" id="customUrl" placeholder="输入网址（如https://www.baidu.com）" class="flex-1 min-w-[200px] p-2 border rounded" value="https://www.baidu.com">
                <button onclick="testCustomUrl()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded transition">测试自定义网址</button>
            </div>
            
            <div id="urlTestResult" class="space-y-3"></div>
        </div>

        <!-- 页面3：IP与DNS归属地（替换无验证API） -->
        <div id="page3" class="page">
            <h2 class="text-xl font-bold text-blue-600 mb-4">IP与DNS归属地查询</h2>
            <p class="text-gray-600 mb-4">使用ipify+ip-api.io无验证API，无拦截风险</p>
            <button onclick="testIPAndDNSLocation()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-6 transition">开始查询</button>
            <div id="ipDnsLocationResult" class="bg-gray-50 p-4 rounded min-h-[150px] whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        // 页面切换逻辑（兼容所有浏览器）
        function switchPage(pageId) {
            const targetBtn = event.target;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(pageId).classList.add('active');
            targetBtn.classList.remove('bg-gray-200', 'text-gray-700');
            targetBtn.classList.add('bg-blue-500', 'text-white');
        }

        // -------------------------- 页面1：DNS测试（修复核心：阿里DNS开放API） --------------------------
        const dnsServers = [
            { name: "国内-114 DNS", ip: "114.114.114.114" },
            { name: "国内-阿里DNS", ip: "223.5.5.5" },
            { name: "国内-腾讯DNS", ip: "119.29.29.29" },
            { name: "国内-华为DNS", ip: "124.160.88.160" },
            { name: "国内-移动DNS", ip: "211.137.191.26" },
            { name: "国外-Google DNS", ip: "8.8.8.8" },
            { name: "国外-Cloudflare DNS", ip: "1.1.1.1" },
            { name: "国外-OpenDNS", ip: "208.67.222.222" }
        ];

        // 单个DNS测试（调用阿里DNS API，无跨域）
        async function testSingleDNS(server) {
            return new Promise(async (resolve) => {
                const start = performance.now();
                try {
                    // 阿里DNS开放API：支持指定DNS服务器解析，自带跨域许可
                    const res = await fetch(`https://dns.alidns.com/resolve?name=baidu.com&server=${server.ip}&type=A&format=json`, {
                        timeout: 5000,
                        headers: { 'Accept': 'application/json' }
                    });
                    const data = await res.json();
                    const end = performance.now();

                    if (data.Status === 0) {
                        resolve({
                            server,
                            status: "success",
                            delay: (end - start).toFixed(2),
                            ip: data.Answer[0].data,
                            protocol: "UDP（API默认）"
                        });
                    } else {
                        resolve({
                            server,
                            status: "error",
                            delay: (end - start).toFixed(2),
                            reason: `DNS错误：${getDnsErrorDesc(data.Status)}`
                        });
                    }
                } catch (err) {
                    const end = performance.now();
                    resolve({
                        server,
                        status: "error",
                        delay: (end - start).toFixed(2),
                        reason: err.name === 'AbortError' ? '5秒超时' : '网络连接失败'
                    });
                }
            });
        }

        // DNS错误码描述（提升可读性）
        function getDnsErrorDesc(code) {
            const descMap = {
                1: "格式错误",
                2: "服务器响应失败",
                3: "域名不存在",
                4: "不支持的解析类型",
                5: "服务器拒绝解析"
            };
            return descMap[code] || `未知错误（代码：${code}）`;
        }

        // 批量测试所有DNS
        async function testAllDNS() {
            const resultEl = document.getElementById('dnsTestResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在测试8个DNS服务器，请稍候...';
            let html = '';

            const testResults = await Promise.all(dnsServers.map(server => testSingleDNS(server)));
            
            testResults.forEach(res => {
                if (res.status === "success") {
                    html += `<div class="test-item success">
                        <strong>${res.server.name}</strong>（${res.server.ip}）<br>
                        状态：成功 | 协议：${res.protocol} | 延迟：${res.delay}ms | 解析IP：${res.ip}
                    </div>`;
                } else {
                    html += `<div class="test-item error">
                        <strong>${res.server.name}</strong>（${res.server.ip}）<br>
                        状态：失败 | 耗时：${res.delay}ms | 原因：${res.reason}
                    </div>`;
                }
            });

            resultEl.innerHTML = html;
        }

        // -------------------------- 页面2：网址延迟测试（新增17个高频网址） --------------------------
        const defaultUrls = [
            // 国内高频（10个）
            { name: "国内-百度", url: "https://www.baidu.com/favicon.ico" },
            { name: "国内-淘宝", url: "https://www.taobao.com/favicon.ico" },
            { name: "国内-京东", url: "https://www.jd.com/favicon.ico" },
            { name: "国内-知乎", url: "https://www.zhihu.com/favicon.ico" },
            { name: "国内-微信", url: "https://weixin.qq.com/favicon.ico" },
            { name: "国内-抖音", url: "https://www.douyin.com/favicon.ico" },
            { name: "国内-微博", url: "https://weibo.com/favicon.ico" },
            { name: "国内-网易", url: "https://www.163.com/favicon.ico" },
            { name: "国内-腾讯视频", url: "https://v.qq.com/favicon.ico" },
            { name: "国内-阿里云", url: "https://www.aliyun.com/favicon.ico" },
            // 国外高频（7个）
            { name: "国外-Google", url: "https://www.google.com/favicon.ico" },
            { name: "国外-GitHub", url: "https://github.com/favicon.ico" },
            { name: "国外-Cloudflare", url: "https://www.cloudflare.com/favicon.ico" },
            { name: "国外-Apple", url: "https://www.apple.com/favicon.ico" },
            { name: "国外-Youtube", url: "https://www.youtube.com/favicon.ico" },
            { name: "国外-Twitter", url: "https://twitter.com/favicon.ico" },
            { name: "国外-Facebook", url: "https://www.facebook.com/favicon.ico" }
        ];

        // 单个网址测试（图标加载计时，无跨域拦截）
        async function testSingleUrl(item) {
            return new Promise((resolve) => {
                const img = new Image();
                const start = performance.now();
                const timeoutId = setTimeout(() => {
                    resolve({ item, status: "error", delay: "8000.00", reason: "8秒超时未响应" });
                }, 8000);

                img.onload = () => {
                    clearTimeout(timeoutId);
                    const end = performance.now();
                    resolve({
                        item,
                        status: "success",
                        delay: (end - start).toFixed(2),
                        info: "图标加载成功"
                    });
                };

                img.onerror = () => {
                    clearTimeout(timeoutId);
                    const end = performance.now();
                    resolve({
                        item,
                        status: "error",
                        delay: (end - start).toFixed(2),
                        reason: "图标加载失败（可能被屏蔽或网址无效）"
                    });
                };

                img.src = `${item.url}?t=${Date.now()}`; // 加时间戳防缓存
            });
        }

        // 批量测试所有网址（按国内/国外分组）
        async function testAllUrls() {
            const resultEl = document.getElementById('urlTestResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在测试17个网址，请稍候...';
            let html = '';

            const testResults = await Promise.all(defaultUrls.map(item => testSingleUrl(item)));
            const domestic = testResults.filter(res => res.item.name.startsWith('国内'));
            const foreign = testResults.filter(res => res.item.name.startsWith('国外'));

            // 国内网址结果
            html += '<div class="font-semibold text-gray-700 mb-2 mt-2">【国内高频网址】</div>';
            domestic.forEach(res => {
                const baseUrl = res.item.url.replace('/favicon.ico', '');
                html += res.status === "success" 
                    ? `<div class="test-item success">
                        <strong>${res.item.name}</strong>（${baseUrl}）<br>
                        状态：成功 | 延迟：${res.delay}ms | 信息：${res.info}
                    </div>`
                    : `<div class="test-item error">
                        <strong>${res.item.name}</strong>（${baseUrl}）<br>
                        状态：失败 | 耗时：${res.delay}ms | 原因：${res.reason}
                    </div>`;
            });

            // 国外网址结果
            html += '<div class="font-semibold text-gray-700 mb-2 mt-4">【国外高频网址】</div>';
            foreign.forEach(res => {
                const baseUrl = res.item.url.replace('/favicon.ico', '');
                html += res.status === "success" 
                    ? `<div class="test-item success">
                        <strong>${res.item.name}</strong>（${baseUrl}）<br>
                        状态：成功 | 延迟：${res.delay}ms | 信息：${res.info}
                    </div>`
                    : `<div class="test-item error">
                        <strong>${res.item.name}</strong>（${baseUrl}）<br>
                        状态：失败 | 耗时：${res.delay}ms | 原因：${res.reason}
                    </div>`;
            });

            resultEl.innerHTML = html;
        }

        // 测试自定义网址
        async function testCustomUrl() {
            const inputUrl = document.getElementById('customUrl').value.trim();
            const resultEl = document.getElementById('urlTestResult');
            
            if (!inputUrl.startsWith('http')) {
                alert("请输入完整网址（需包含http://或https://）");
                return;
            }

            const testUrl = inputUrl.endsWith('/') ? `${inputUrl}favicon.ico` : `${inputUrl}/favicon.ico`;
            const item = { name: "自定义网址", url: testUrl };
            resultEl.innerHTML = `<span class="loading">●</span>正在测试自定义网址：${inputUrl}`;
            
            const res = await testSingleUrl(item);
            let customHtml = '';
            if (res.status === "success") {
                customHtml = `<div class="test-item success border-t-2 border-green-500 pt-3 mt-3">
                    <strong>自定义网址</strong>（${inputUrl}）<br>
                    状态：成功 | 延迟：${res.delay}ms | 信息：${res.info}
                </div>`;
            } else {
                customHtml = `<div class="test-item error border-t-2 border-red-500 pt-3 mt-3">
                    <strong>自定义网址</strong>（${inputUrl}）<br>
                    状态：失败 | 耗时：${res.delay}ms | 原因：${res.reason}
                </div>`;
            }

            // 插入到结果顶部
            const existingHtml = resultEl.innerHTML.replace('<span class="loading">●</span>正在测试自定义网址：' + inputUrl, '');
            resultEl.innerHTML = customHtml + existingHtml;
            document.getElementById('customUrl').value = '';
        }

        // -------------------------- 页面3：IP与DNS归属地（修复核心：无验证API） --------------------------
        async function testIPAndDNSLocation() {
            const resultEl = document.getElementById('ipDnsLocationResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在查询IP与DNS归属地，请稍候...';
            
            try {
                                // 1. 获取公网IP（ipify：无验证、无跨域）
                const ipRes = await fetch('https://api.ipify.org?format=json', { timeout: 5000 });
                const ipData = await ipRes.json();
                const publicIp = ipData.ip; // 提取公网IP

                // 2. 获取IP归属地（ip-api.io：无验证，支持全球IP查询）
                const ipLocRes = await fetch(`https://ip-api.io/json/${publicIp}?fields=country_name,region_name,city,isp,timezone`, { timeout: 5000 });
                const ipLocData = await ipLocRes.json();

                // 3. 获取DNS服务器地址（Cloudflare Trace：无验证，直接返回DNS信息）
                const dnsTraceRes = await fetch('https://www.cloudflare.com/cdn-cgi/trace', { timeout: 5000 });
                const dnsTraceText = await dnsTraceRes.text();
                const traceLines = dnsTraceText.split('\n');
                const dnsIp = traceLines.find(line => line.startsWith('dns='))?.split('=')[1] || '未知'; // 提取DNS IP

                // 4. 获取DNS归属地（若DNS IP存在则查询）
                let dnsLoc = '未知';
                if (dnsIp !== '未知' && dnsIp !== '') {
                    const dnsLocRes = await fetch(`https://ip-api.io/json/${dnsIp}?fields=country_name,region_name,city`, { timeout: 5000 });
                    const dnsLocData = await dnsLocRes.json();
                    dnsLoc = `${dnsLocData.country_name || '未知'} ${dnsLocData.region_name || ''} ${dnsLocData.city || ''}`.trim();
                }

                // 整理查询结果，格式清晰
                const result = `
当前网络信息查询结果：
1. 公网IP地址：${publicIp}
   - 归属地：${ipLocData.country_name || '未知'} ${ipLocData.region_name || ''} ${ipLocData.city || ''}
   - 运营商：${ipLocData.isp || '未知'}
   - 时区：${ipLocData.timezone || '未知'}

2. DNS服务器信息：
   - DNS IP：${dnsIp}
   - DNS归属地：${dnsLoc}
                `;
                resultEl.textContent = result; // 显示结果
            } catch (err) {
                // 错误处理，提示具体原因
                resultEl.textContent = `查询失败：${err.message || '未知错误'}\n建议：1. 关闭广告拦截插件 2. 检查网络连接 3. 刷新页面重试`;
            }
        }
    </script>
</body>
</html>

