<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DNS直连测试工具（支持DoH/DoT）</title>
    <style>
        /* 全局样式重置与基础配置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        }
        body {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.2rem;
            background-color: #f9fafb;
            color: #111827;
        }

        /* 页面标题样式 */
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .page-title {
            font-size: 1.9rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.8rem;
        }
        .page-desc {
            font-size: 0.95rem;
            color: #6b7280;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 测试按钮样式 */
        .test-control {
            text-align: center;
            margin-bottom: 1.8rem;
        }
        #startTest {
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 1.05rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        #startTest:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
        }
        #startTest:disabled {
            background: #a7f3d0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 测试总结区域 */
        .test-summary {
            max-width: 1000px;
            margin: 0 auto 1.5rem;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            color: #2d3748;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* DNS表格样式 */
        .dns-table-wrapper {
            overflow-x: auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .dns-table {
            width: 100%;
            border-collapse: collapse;
        }
        .dns-table th {
            background-color: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 1.1rem 1.2rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .dns-table td {
            padding: 1.1rem 1.2rem;
            font-size: 0.9rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        .dns-table tbody tr:hover {
            background-color: #fafafa;
        }

        /* 协议标签样式 */
        .protocol-tag {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.4rem;
        }
        .tag-doh {
            background-color: #d1fae5;
            color: #059669;
        }
        .tag-dot {
            background-color: #dbeafe;
            color: #2563eb;
        }

        /* 状态标签样式 */
        .status-tag {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        .status-success {
            background-color: #d1fae5;
            color: #059669;
        }
        .status-failed {
            background-color: #fecdd3;
            color: #dc2626;
        }

        /* 页脚说明 */
        .page-footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.85rem;
            color: #6b7280;
            line-height: 1.5;
        }

        /* 响应式适配（手机端） */
        @media (max-width: 768px) {
            .page-title {
                font-size: 1.6rem;
            }
            .page-desc {
                font-size: 0.9rem;
                padding: 0 0.5rem;
            }
            #startTest {
                padding: 0.9rem 2rem;
                font-size: 1rem;
            }
            .dns-table th,
            .dns-table td {
                padding: 0.9rem 0.8rem;
                font-size: 0.85rem;
            }
            .protocol-tag,
            .status-tag {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- 页面头部 -->
    <div class="page-header">
        <h1 class="page-title">DNS服务器直连测试工具</h1>
        <p class="page-desc">支持DoH（DNS-over-HTTPS）/DoT（DNS-over-TLS）双协议检测，覆盖国内外主流DNS，6秒超时判定</p>
    </div>

    <!-- 测试控制区 -->
    <div class="test-control">
        <button id="startTest">开始测试所有DNS</button>
    </div>

    <!-- 测试总结区 -->
    <div class="test-summary" id="testSummary">
        点击上方按钮启动测试，结果将实时更新
    </div>

    <!-- DNS表格区 -->
    <div class="dns-table-wrapper">
        <table class="dns-table">
            <thead>
                <tr>
                    <<th>DNS服务器名称</</th>
                    <<th>服务器地址</</th>
                    <<th>端口</</th>
                    <<th>支持协议</</th>
                    <<th>直连状态</</th>
                </tr>
            </thead>
            <tbody id="dnsTableBody">
                <!-- JS动态插入DNS列表 -->
            </tbody>
        </table>
    </div>

    <!-- 页脚说明 -->
    <div class="page-footer">
        测试原理：通过验证DNS解析github.com的A记录判定可用性 | 结果仅代表当前网络环境，若全部失败可能是本地网络限制
    </div>

    <script>
        // 1. 完整DNS服务器列表（含DoH/DoT配置，覆盖国内外主流+特色DNS）
        const dnsServers = [
            // 境外DNS（DoH+DoT双协议）
            {
                name: "Cloudflare DNS",
                ip: "1.1.1.1",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://cloudflare-dns.com/dns-query",
                dotDomain: "one.one.one.one"
            },
            {
                name: "Google DNS",
                ip: "8.8.8.8",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://dns.google/dns-query",
                dotDomain: "dns.google"
            },
            {
                name: "Quad9 DNS（安全过滤）",
                ip: "9.9.9.9",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://dns.quad9.net/dns-query",
                dotDomain: "dns.quad9.net"
            },
            {
                name: "AdGuard DNS（去广告）",
                ip: "94.140.14.14",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://dns.adguard-dns.com/dns-query",
                dotDomain: "dns.adguard-dns.com"
            },
            // 国内公共DNS（DoH为主，部分支持DoT）
            {
                name: "阿里公共DNS",
                ip: "223.5.5.5",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://dns.alidns.com/dns-query",
                dotDomain: "dns.alidns.com"
            },
            {
                name: "腾讯公共DNS",
                ip: "119.29.29.29",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://doh.pub/dns-query",
                dotDomain: "doh.pub"
            },
            {
                name: "百度公共DNS",
                ip: "180.76.76.76",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://doh.baidu.com/dns-query",
                dotDomain: "doh.baidu.com"
            },
            {
                name: "华为公共DNS",
                ip: "114.114.114.114",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://doh.114dns.com/dns-query",
                dotDomain: "doh.114dns.com"
            },
            {
                name: "CNNIC DNS",
                ip: "1.2.4.8",
                port: "443/853",
                protocol: ["DoH", "DoT"],
                dohUrl: "https://doh.cnnic.cn/dns-query",
                dotDomain: "doh.cnnic.cn"
            },
            // 国内运营商DNS（分地区）
            {
                name: "联通DNS（北京）",
                ip: "202.106.0.20",
                port: "443",
                protocol: ["DoH"],
                dohUrl: "https://202.106.0.20/dns-query"
            },
            {
                name: "电信DNS（上海）",
                ip: "202.96.209.133",
                port: "443",
                protocol: ["DoH"],
                dohUrl: "https://202.96.209.133/dns-query"
            },
            {
                name: "移动DNS（广州）",
                ip: "211.136.192.6",
                port: "443",
                protocol: ["DoH"],
                dohUrl: "https://211.136.192.6/dns-query"
            }
        ];

        // 2. DOM元素获取
        const startTestBtn = document.getElementById("startTest");
        const testSummary = document.getElementById("testSummary");
        const dnsTableBody = document.getElementById("dnsTableBody");
        let successCount = 0;
        const totalDnsCount = dnsServers.length;

        // 3. 初始化DNS表格
        function initDnsTable() {
            dnsTableBody.innerHTML = "";
            testSummary.textContent = `准备测试：共${totalDnsCount}个DNS服务器，6秒超时判定`;
            successCount = 0;

            dnsServers.forEach((dns, index) => {
                // 生成协议标签HTML
                const protocolTags = dns.protocol.map(pro => 
                    `<span class="protocol-tag tag-${pro.toLowerCase()}">${pro}</span>`
                ).join("");

                // 创建表格行
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${dns.name}</td>
                    <td>${dns.ip}</td>
                    <td>${dns.port}</td>
                    <td>${protocolTags}</td>
                    <td><span class="status-tag status-pending" id="status-${index}">等待测试</span></td>
                `;
                dnsTableBody.appendChild(row);
            });
        }

        // 4. DoH协议测试（验证真实解析能力）
        function testDoh(dns) {
            return new Promise((resolve) => {
                if (!dns.dohUrl) {
                    resolve(false);
                    return;
                }

                const controller = new AbortController();
                const signal = controller.signal;
                const timeoutTimer = setTimeout(() => controller.abort(), 6000);

                // 构造DoH请求：查询github.com的A记录（Type=1）
                const dohUrl = new URL(dns.dohUrl);
                dohUrl.searchParams.set("name", "github.com");
                dohUrl.searchParams.set("type", "A");
                dohUrl.searchParams.set("ct", "application/dns-json");

                fetch(dohUrl.toString(), {
                    method: "GET",
                    headers: { "Accept": "application/dns-json" },
                    signal
                })
                .then(response => {
                    if (!response.ok) throw new Error("DoH响应异常");
                    return response.json();
                })
                .then(data => {
                    // 验证解析结果：是否包含github.com的A记录
                    const isValid = data.Answer && data.Answer.some(item => 
                        item.Name === "github.com." && item.Type === 1
                    );
                    resolve(isValid);
                })
                .catch(() => {
                    resolve(false);
                })
                .finally(() => {
                    clearTimeout(timeoutTimer);
                });
            });
        }

        // 5. DoT协议测试（基于WSS模拟TLS握手）
        function testDot(dns) {
            return new Promise((resolve) => {
                if (!dns.dotDomain || !dns.port.includes("853")) {
                    resolve(false);
                    return;
                }

                // 用WSS模拟DoT的TLS连接（浏览器无直接TCP权限）
                const wssUrl = `wss://${dns.ip}:853/`;
                const ws = new WebSocket(wssUrl);
                const timeoutTimer = setTimeout(() => {
                    ws.close();
                    resolve(false);
                }, 6000);

                ws.onopen = () => {
                    clearTimeout(timeoutTimer);
                    ws.close();
                    resolve(true);
                };

                ws.onerror = () => {
                    clearTimeout(timeoutTimer);
                    resolve(false);
                };
            });
        }

        // 6. 单DNS完整测试（DoH优先，再测DoT）
async function testSingleDns(dns, index) {
    const statusElement = document.getElementById(`status-${index}`);
    statusElement.className = "status-tag status-pending";
    statusElement.textContent = "测试中（DoH）";

    // 第一步：测试DoH协议
    const dohPass = await testDoh(dns);
    if (dohPass) {
        statusElement.className = "status-tag status-success";
        statusElement.textContent = "成功（DoH）";
        successCount++;
        return;
    }

    // 第二步：若支持DoT，测试DoT协议
    if (dns.protocol.includes("DoT")) {
        statusElement.textContent = "测试中（DoT）";
        const dotPass = await testDot(dns);
        if (dotPass) {
            statusElement.className = "status-tag status-success";
            statusElement.textContent = "成功（DoT）";
            successCount++;
            return;
        }
    }

    // 第三步：双协议均失败
    statusElement.className = "status-tag status-failed";
    statusElement.textContent = "失败（双协议不可用）";
}

// 7. 批量测试所有DNS（控制间隔避免浏览器请求阻塞）
async function testAllDns() {
    initDnsTable();
    startTestBtn.disabled = true;

    // 逐个测试，每个间隔500ms，防止并发请求被拦截
    for (let i = 0; i < dnsServers.length; i++) {
        await testSingleDns(dnsServers[i], i);
        // 等待500ms再测下一个
        await new Promise(resolve => setTimeout(resolve, 500));
    }

    // 所有测试完成后更新总结
    testSummary.textContent = `测试完成：共${totalDnsCount}个DNS，成功${successCount}个，失败${totalDnsCount - successCount}个`;
    startTestBtn.disabled = false;
}

// 8. 绑定按钮事件+页面初始化
startTestBtn.addEventListener("click", testAllDns);
window.onload = initDnsTable;
    </script>
</body>
</html>

                                     
