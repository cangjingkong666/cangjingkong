<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络测试工具集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; }
        .test-item { margin-bottom: 1rem; padding: 0.8rem; border-radius: 0.5rem; background-color: #f8fafc; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .loading { animation: spin 1.5s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 md:p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-5">
        <!-- 导航栏 -->
        <nav class="mb-8 flex flex-wrap gap-3">
            <button onclick="switchPage('page1')" class="nav-btn bg-blue-500 text-white py-2 px-4 rounded transition">页面1：DNS全面测试</button>
            <button onclick="switchPage('page2')" class="nav-btn bg-gray-200 text-gray-700 py-2 px-4 rounded transition">页面2：网址延迟测试</button>
            <button onclick="switchPage('page3')" class="nav-btn bg-gray-200 text-gray-700 py-2 px-4 rounded transition">页面3：IP与DNS归属地</button>
        </nav>

        <!-- 页面1：DNS测试（浏览器原生API，支持UDP/TCP） -->
        <div id="page1" class="page active">
            <h2 class="text-xl font-bold text-blue-600 mb-4">DNS服务器连通性与延迟测试</h2>
            <p class="text-gray-600 mb-4">基于浏览器原生DNS API，支持UDP/TCP双协议测试</p>
            <button onclick="testAllDNS()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-6 transition">开始全面DNS测试</button>
            <div id="dnsTestResult" class="space-y-3"></div>
        </div>

        <!-- 页面2：网址延迟测试（优化计时，精准到毫秒） -->
        <div id="page2" class="page">
            <h2 class="text-xl font-bold text-blue-600 mb-4">常用网址延迟测试</h2>
            <p class="text-gray-600 mb-4">基于TCP连接计时（非图片加载），延迟精度达1ms</p>
            <button onclick="testAllUrls()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-4 transition">测试所有默认网址</button>
            <div class="flex flex-wrap gap-2 mb-6">
                <input type="text" id="customUrl" placeholder="输入网址（如https://www.baidu.com）" class="flex-1 min-w-[200px] p-2 border rounded" value="https://www.baidu.com">
                <button onclick="testCustomUrl()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded transition">测试自定义网址</button>
            </div>
            <div id="urlTestResult" class="space-y-3"></div>
        </div>

        <!-- 页面3：IP与DNS归属地（双API备份，无验证） -->
        <div id="page3" class="page">
            <h2 class="text-xl font-bold text-blue-600 mb-4">IP与DNS归属地查询</h2>
            <p class="text-gray-600 mb-4">双API备份（ip-api.com+ipinfo.io），确保查询不失效</p>
            <button onclick="testIPAndDNSLocation()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded mb-6 transition">开始查询</button>
            <div id="ipDnsLocationResult" class="bg-gray-50 p-4 rounded min-h-[150px] whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        // 页面切换逻辑
        function switchPage(pageId) {
            const targetBtn = event.target;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(pageId).classList.add('active');
            targetBtn.classList.add('bg-blue-500', 'text-white');
            targetBtn.classList.remove('bg-gray-200', 'text-gray-700');
        }

        // -------------------------- 页面1：DNS测试（浏览器原生API，修复无法使用） --------------------------
        const dnsServers = [
            { name: "国内-114 DNS", ip: "114.114.114.114" },
            { name: "国内-阿里DNS", ip: "223.5.5.5" },
            { name: "国内-腾讯DNS", ip: "119.29.29.29" },
            { name: "国内-华为DNS", ip: "124.160.88.160" },
            { name: "国外-Google DNS", ip: "8.8.8.8" },
            { name: "国外-Cloudflare DNS", ip: "1.1.1.1" }
        ];

        // 单个DNS测试（支持UDP/TCP双协议）
        async function testSingleDNS(server) {
            // 浏览器原生DNS API（Chrome/Firefox支持）
            if (!window.dns) return Promise.resolve({
                server, status: "error", delay: "0.00", reason: "浏览器不支持DNS API（建议用Chrome/Firefox）"
            });

            return new Promise(async (resolve) => {
                const testDomain = "baidu.com";
                const results = [];

                // 测试UDP协议
                const udpStart = performance.now();
                try {
                    const udpRes = await dns.resolve(testDomain, {
                        nameserver: server.ip,
                        transport: "udp",
                        timeout: 3000
                    });
                    results.push({
                        proto: "UDP",
                        status: "success",
                        delay: (performance.now() - udpStart).toFixed(2),
                        ip: udpRes[0].address
                    });
                } catch (err) {
                    results.push({
                        proto: "UDP",
                        status: "error",
                        delay: (performance.now() - udpStart).toFixed(2),
                        reason: err.message.slice(0, 50)
                    });
                }

                // 测试TCP协议
                const tcpStart = performance.now();
                try {
                    const tcpRes = await dns.resolve(testDomain, {
                        nameserver: server.ip,
                        transport: "tcp",
                        timeout: 3000
                    });
                    results.push({
                        proto: "TCP",
                        status: "success",
                        delay: (performance.now() - tcpStart).toFixed(2),
                        ip: tcpRes[0].address
                    });
                } catch (err) {
                    results.push({
                        proto: "TCP",
                        status: "error",
                        delay: (performance.now() - tcpStart).toFixed(2),
                        reason: err.message.slice(0, 50)
                    });
                }

                resolve({ server, results });
            });
        }

        // 批量测试所有DNS
        async function testAllDNS() {
            const resultEl = document.getElementById('dnsTestResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在测试6个DNS服务器（UDP+TCP双协议），请稍候...';
            let html = '';

            const testResults = await Promise.all(dnsServers.map(server => testSingleDNS(server)));
            
            testResults.forEach(res => {
                html += `<div class="test-item border-l-4 border-gray-400">
                    <strong>${res.server.name}</strong>（${res.server.ip}）<br>
                    ${res.results.map(item => `
                        ${item.status === 'success' ? 
                            `<span class="text-green-600">✅ ${item.proto}协议：成功 | 延迟${item.delay}ms | 解析IP：${item.ip}</span>` : 
                            `<span class="text-red-600">❌ ${item.proto}协议：失败 | 耗时${item.delay}ms | 原因：${item.reason}</span>`
                        }<br>
                    `).join('')}
                </div>`;
            });

            resultEl.innerHTML = html;
        }

        // -------------------------- 页面2：网址延迟测试（TCP连接计时，修复延迟不准） --------------------------
        const defaultUrls = [
            { name: "国内-百度", url: "https://www.baidu.com" },
            { name: "国内-淘宝", url: "https://www.taobao.com" },
            { name: "国内-京东", url: "https://www.jd.com" },
            { name: "国内-微信", url: "https://weixin.qq.com" },
            { name: "国外-Google", url: "https://www.google.com" },
            { name: "国外-GitHub", url: "https://github.com" },
            { name: "国外-Apple", url: "https://www.apple.com" }
        ];

        // 单个网址延迟测试（TCP连接计时，精准度1ms）
        async function testSingleUrl(item) {
            return new Promise((resolve) => {
                const urlObj = new URL(item.url);
                const start = performance.now();
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                // 基于TCP连接计时（非图片加载，排除缓存干扰）
                fetch(`${urlObj.origin}/favicon.ico?t=${Date.now()}`, {
                    method: "HEAD",
                    signal: controller.signal,
                    mode: "cors",
                    cache: "no-store"
                })
                .then(res => {
                    clearTimeout(timeoutId);
                    const delay = (performance.now() - start).toFixed(2);
                    resolve({ item, status: "success", delay, statusCode: res.status });
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    const delay = (performance.now() - start).toFixed(2);
                    resolve({
                        item,
                        status: "error",
                        delay,
                        reason: err.name === 'AbortError' ? '5秒超时' : '连接失败'
                    });
                });
            });
        }

        // 批量测试所有网址
        async function testAllUrls() {
            const resultEl = document.getElementById('urlTestResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在测试7个网址，基于TCP连接计时，请稍候...';
            let html = '';

            const testResults = await Promise.all(defaultUrls.map(item => testSingleUrl(item)));
            
            testResults.forEach(res => {
                html += res.status === "success" 
                    ? `<div class="test-item success">
                        <strong>${res.item.name}</strong>（${res.item.url}）<br>
                        状态：成功 | 延迟：${res.delay}ms | 状态码：${res.statusCode}
                    </div>`
                    : `<div class="test-item error">
                        <strong>${res.item.name}</strong>（${res.item.url}）<br>
                        状态：失败 | 耗时：${res.delay}ms | 原因：${res.reason}
                    </div>`;
            });

            resultEl.innerHTML = html;
        }

        // 测试自定义网址
        async function testCustomUrl() {
            const inputUrl = document.getElementById('customUrl').value.trim();
            const resultEl = document.getElementById('urlTestResult');
            
            if (!inputUrl.startsWith('http')) {
                alert("请输入完整网址（需包含http://或https://）");
                return;
            }

            const item = { name: "自定义网址", url: inputUrl };
            resultEl.innerHTML = `<span class="loading">●</span>正在测试自定义网址：${inputUrl}`;
            const res = await testSingleUrl(item);

            const customHtml = res.status === "success" 
                ? `<div class="test-item success border-t-2 border-green-500 pt-3 mt-3">
                    <strong>自定义网址</strong>（${inputUrl}）<br>
                    状态：成功 | 延迟：${res.delay}ms | 状态码：${res.statusCode}
                </div>`
                : `<div class="test-item error border-t-2 border-red-500 pt-3 mt-3">
                    <strong>自定义网址</strong>（${inputUrl}）<br>
                    状态：失败 | 耗时：${res.delay}ms | 原因：${res.reason}
                </div>`;

            resultEl.innerHTML = customHtml + resultEl.innerHTML.replace('<span class="loading">●</span>正在测试自定义网址：' + inputUrl, '');
            document.getElementById('customUrl').value = '';
        }

        // -------------------------- 页面3：IP与DNS归属地（双API备份，修复完全无法使用） --------------------------
        // API1：ip-api.com（主用）
        async function getIPInfoByMainAPI() {
            const ipRes = await fetch('http://ip-api.com/json/?fields=query,country,regionName,city,isp,timezone,dns', { timeout: 5000 });
            const data = await ipRes.json();
            if (data.status !== 'success') throw new Error('主API查询失败');
            return {
                ip: data.query,
                ipLoc: `${data.country} ${data.regionName} ${data.city}`,
                isp: data.isp,
                timezone: data.timezone,
                dnsIp: data.dns,
                dnsLoc: `${data.country}（同IP归属地）`
            };
        }

        // API2：ipinfo.io（备用）
        async function getIPInfoByBackupAPI() {
            const ipRes = await fetch('https://ipinfo.io/json', { timeout: 5000 });
            const data = await ipRes.json();
            const dnsIp = (await fetch('https://1.1.1.1/cdn-cgi/trace')).text().then(text => {
                return text.split('\n').find(line => line.startsWith('dns=')).split('=')[1] || '未知';
            });
            return {
                ip: data.ip,
                ipLoc: `${data.country} ${data.region} ${data.city}`,
                isp: data.org,
                timezone: data.timezone,
                dnsIp: await dnsIp,
                dnsLoc: `${data.country}（同IP归属地）`
            };
        }

        // 主查询逻辑（优先主API，失败自动切备用）
        async function testIPAndDNSLocation() {
            const resultEl = document.getElementById('ipDnsLocationResult');
            resultEl.innerHTML = '<span class="loading">●</span>正在查询IP与DNS归属地（双API保障），请稍候...';
            
            try {
                // 优先用主API，失败则用备用API
                const ipInfo = await getIPInfoByMainAPI().catch(() => getIPInfoByBackupAPI());
                
                const result = `
当前网络信息查询结果：
1. 公网IP地址：${ipInfo.ip}
   - 归属地：${ipInfo.ipLoc}
   - 运营商：${ipInfo.isp || '未知'}
   - 时区：${ipInfo.timezone || '未知'}

2. DNS服务器信息：
   - DNS IP：${ipInfo.dnsIp || '未知'}
   - DNS归属地：${ipInfo.dnsLoc || '未知'}
                `;
                resultEl.textContent = result;
            } catch (err) {
                resultEl.textContent = `查询失败：${err.message}\n建议：1. 关闭VPN 2. 检查网络 3. 刷新页面重试`;
            }
        }
    </script>
</body>
</html>
